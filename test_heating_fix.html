<!DOCTYPE html>
<html>
<head>
    <title>Test Heating Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
        }
        .test-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #444;
        }
        .test-description {
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .code-block {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            overflow-x: auto;
        }
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        .issue {
            color: #FF5722;
            font-weight: bold;
        }
        .fixed {
            color: #2196F3;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Heating Rectangle Overflow Fix Test</h1>

        <div class="test-section">
            <div class="test-title">Problem Description</div>
            <div class="test-description">
                <span class="issue">Issue:</span> When zooming in the chart, the heating rectangles (hvac_action) overflow the graph on the X-axis and display over the Y-axis scales.
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">Root Cause Analysis</div>
            <div class="test-description">
                The heating rectangles were using hardcoded coordinates without proper clipping to the visible chart area. The main issues were:
                <ul>
                    <li>No clipping to chart boundaries (left/right edges)</li>
                    <li>No consideration for zoom level and pan offset</li>
                    <li>Rectangles could extend beyond the visible chart area</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">Solution Implemented</div>
            <div class="test-description">
                <span class="fixed">Fixed:</span> Added proper clipping logic to constrain heating rectangles within the visible chart area:
                <ul>
                    <li>Calculate chart boundaries (chartLeft, chartRight, chartBottom)</li>
                    <li>Clip rectangle X position to stay within chart left boundary</li>
                    <li>Clip rectangle width to not exceed chart right boundary</li>
                    <li>Added clip-path attribute to ensure proper SVG clipping</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">Code Changes</div>
            <div class="code-block">
// Before (problematic code):
const x1 = getX(heating[i].t);
const x2 = getX(heating[i + 1].t);
const w = x2 - x1;
if (w > 0) {
    heatingRects.push(svg`
        <rect
            x="${x1}"
            y="${padding.top + chartHeight - 20}"
            width="${w}"
            height="20"
            fill="rgba(255, 152, 0, 0.5)"
        />
    `);
}

// After (fixed code):
const chartLeft = padding.left;
const chartRight = width - padding.right;
const chartBottom = padding.top + chartHeight;

const x1 = getX(heating[i].t);
const x2 = getX(heating[i + 1].t);

// Clip the rectangle to the visible chart area
const rectX = Math.max(chartLeft, Math.min(x1, x2));
const rectWidth = Math.max(0, Math.min(chartRight, Math.max(x1, x2)) - rectX);

if (rectWidth > 0) {
    heatingRects.push(svg`
        <rect
            x="${rectX}"
            y="${chartBottom - 20}"
            width="${rectWidth}"
            height="20"
            fill="rgba(255, 152, 0, 0.5)"
            clip-path="url(#chart-clip)"
        />
    `);
}
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">Expected Results</div>
            <div class="test-description">
                <span class="success">âœ“</span> Heating rectangles should now:
                <ul>
                    <li>Stay within the visible chart area during zoom operations</li>
                    <li>Not overflow onto the Y-axis scales</li>
                    <li>Be properly clipped when partially outside the visible area</li>
                    <li>Maintain correct positioning relative to the time axis</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">Test Instructions</div>
            <div class="test-description">
                To test the fix:
                <ol>
                    <li>Load the card in Home Assistant</li>
                    <li>Zoom in/out using mouse wheel or zoom controls</li>
                    <li>Verify that heating rectangles stay within chart boundaries</li>
                    <li>Check that rectangles don't overlap Y-axis labels</li>
                    <li>Test panning to ensure rectangles move correctly</li>
                </ol>
            </div>
        </div>
    </div>
</body>
</html>